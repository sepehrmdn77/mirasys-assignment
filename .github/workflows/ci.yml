on:
  push:
    branches: [ main ]
    tags: [ 'v*.*.*' ]
    paths:
      - '!helm/**'
      - '!infra/**'
      - '!gitops/**'
      - '!assets/**'
      - '!README.md'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY: docker.io
  IMAGE_NAME: mirasys-assignment

jobs:
  build:
    name: 'Build and Test'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 'Setup .NET'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: 'Restore dependencies'
        run: dotnet restore ./app/ServiceExample.sln

      - name: 'Build application'
        run: dotnet build ./app/ServiceExample.sln --configuration Release --no-restore

      - name: 'Run tests'
        run: |
          dotnet test ./app/ --configuration Release --no-build --verbosity normal

  docker_image:
    name: 'Build Docker image'
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 'Azure CLI login via service principal and fetch secrets'
        run: |
          echo "-> Logging in with service principal"
          az login --service-principal -u "${{ secrets.AZURE_CLIENT_ID }}" -p "${{ secrets.AZURE_CLIENT_SECRET }}" --tenant "${{ secrets.AZURE_TENANT_ID }}"
          az account set --subscription "${{ secrets.AZURE_SUBSCRIPTION_ID }}" || true
          az account show
          set -euo pipefail
          echo "-> Reading secrets from Key Vault: mirasys-keys"
          REG_USER=$(az keyvault secret show --vault-name mirasys-keys --name RegistryUsername --query value -o tsv)
          REG_PASS=$(az keyvault secret show --vault-name mirasys-keys --name RegistryPassword --query value -o tsv)
          if [ -z "$REG_USER" ] || [ -z "$REG_PASS" ]; then
            echo "ERROR: Could not fetch one or more secrets from Key Vault" >&2
            exit 1
          fi
          echo "REGISTRY_USERNAME=$REG_USER" >> $GITHUB_ENV
          echo "REGISTRY_PASSWORD=$REG_PASS" >> $GITHUB_ENV
        env:
          AZURE_CONFIG_DIR: ${{ github.workspace }}/.azure

      - name: 'Extract version metadata'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY_USERNAME }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch,priority=200
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=sha-
          flavor: |
            latest=${{ github.ref == 'refs/heads/main' }}
          labels: |
            org.opencontainers.image.title=mirasys-assignment
            org.opencontainers.image.description=.NET Application
            org.opencontainers.image.vendor=DevSepOps

      - name: 'Debug meta outputs'
        run: |
          echo "META TAGS: ${{ steps.meta.outputs.tags }}"
          echo "META LABELS: ${{ steps.meta.outputs.labels }}"
          sleep 5

      - name: 'Setup Docker Buildx'
        uses: docker/setup-buildx-action@v3

      - name: 'Login to Docker Hub'
        uses: docker/login-action@v3
        with:
          username: ${{ env.REGISTRY_USERNAME }}
          password: ${{ env.REGISTRY_PASSWORD }}

      - name: 'Build and push Docker image'
        uses: docker/build-push-action@v5
        with:
          context: ./app
          file: ./app/ServiceExample/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1
